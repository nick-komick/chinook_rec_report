\clearpage

# Results

```{r results loading data, message=FALSE, warning=FALSE, results='hide', echo=FALSE}

Sport_mark_rate_finescale_combined<-wrangle_rec_catch("pacRecCatch_db.yaml", by="fishery", most_recent_data_year=2023)

Sport_mark_rate_finescale<-wrangle_rec_catch("pacRecCatch_db.yaml", by="area", most_recent_data_year=2023)


models_combined <- pacRecCatch::model_rec_catch(Sport_mark_rate_finescale_combined, most_recent_data_year=2023)


Sport_mark_rate_mrr_corrected<-get_release_rates(models_combined, Sport_mark_rate_finescale)

```

## Revised Chinook catch estimates from 2013-present

We found that catch estimates that included iREC data were broadly higher than previous estimates that didn't include iREC information. As an example, Figure \@ref(fig:fig-jdf-catch-revised-1) shows the effect of the summed and revised kept catch estimates for 2013-2023 for Juan de Fuca finescale fishery (dashed line) compared to the previous estimates without iREC inclusion (solid line). In 2023, the revised estimates were 19% higher than the estimates without iREC included. However, in 2019, the revised estimates were smaller than the previous estimates, likely due to the creel filtration process removing a biased creel estimate. The revised kept catch plots for the remaining fisheries can be found in Appendix A.

*Note: should this be by ERA fishery instead? It's currently finescale fishery old - so not seasonal. If it were ERA fishery then it's identical to the plots in the incorporation section.*

```{r results example summer m plots, results='asis', echo=FALSE}
#| label: fig-jdf-catch-revised-1
#| fig-cap: "Juan de Fuca revised yearly kept catch estimates"


### make this by finescale fishery old... sum up. 
models_combined_old<-models_combined %>% group_by(YEAR,kept_status,pred_cat, finescale_fishery_old) %>% summarise_if(is.numeric, sum, na.rm = TRUE)

fishery_name_south<- sort(unique(models_combined_old$finescale_fishery_old))


i = 1

graph_data <-   models_combined_old  %>% filter(
  finescale_fishery_old == fishery_name_south[i],
  YEAR %in% c(2013:2023),
  kept_status == "Kept") %>%
  ungroup() %>%
  select(YEAR, creel_unfiltered_plus, catch_estimate_predicted) %>%
  pivot_longer(c(creel_unfiltered_plus, catch_estimate_predicted),
               names_to = "estimate_type",
               values_to = "catch_estimate")

m <- ggplot(graph_data,
       aes(y = catch_estimate,
           x = YEAR,
           shape = estimate_type,
           linetype = estimate_type))+
  geom_point(size = 2.5,
             colour = "#440154")+
  geom_line(colour = "#440154") +
  scale_shape_manual(values = c(1, 16),
                     labels = c("iREC included", "Unfiltered creel and logbook")
                     ) +
  scale_linetype_manual(values = c(2, 1),
                      labels = c("iREC included", "Unfiltered creel and logbook")
                      ) +
  scale_x_continuous(breaks = c(2013, 2015, 2017, 2019, 2021, 2023)) +
  ggtitle(paste(fishery_name_south[i])) + 
  theme_bw() + 
  ylab("Kept catch estimate") + 
  xlab("Year") +
  labs(linetype = "Catch Estimate", shape = "Catch Estimate")
 
 print(m)
```

\clearpage

## Revised Chinook catch estimates from 2005-2012

### Model fit

Separate models were developed for summer finescale fisheries than for the combined spring and fall fisheries (with season as a factor). Since Central BC did not have off-season fisheries, one year-round model was developed for CBC Sport. One summer model was developed for all southern BC fisheries, and a separate model each for NBC AABM and NBC ISBM since the input data is different. Overall, models that fit creel summer to creel + iREC summer were a better fit when compared to the models that fit summer creel to data from spring and fall seasons (see Appendix B for residual plots). All the models retained the variable "status" - which fits a different slope to each of the categories Marked Kept, Marked Released, Unmarked Kept and Unmarked Released.

These models are used to develop a relationship between filtered creel + iREC catch in the a given time period (spring (months 1:4), summer (months 5:9), or fall (months 10:12)) and the unfiltered creel and logbook only (i.e. no iREC) catch in the limited creel summer period (months 7:8). This relationship is developed with each datapoint as a single year in the 2013-2023 timeseries (or 2015-2023 for NBC and CBC). The relationship is then used to predict an iREC-like estimate from the limited summertime creel in the years 2005-2012. Here we show the results of the modelling and the relationships developed. In the next section (incorporation of both sets of data), we use the predicted 2005-2012 values along with the observed 2013-2023 to show how PSC products may be changed from this analysis.

```{r plotting_function, include = FALSE}
#plotting function that will be used for the next few sections
create_facet_plot <- function(finescale_fishery_name, x_var, plot_data, model_data) {
  # Labels for facets
  status_labels <- c(
    "marked_Kept_total" = "Marked Kept Total",
    "marked_Released_total" = "Marked Released Total",
    "unmarked_Kept_total" = "Unmarked Kept Total",
    "unmarked_Released_total" = "Unmarked Released Total"
  )
  
  # Colors for status
  status_colors <- c(
    "marked_Kept_total" = "#440154", 
    "marked_Released_total" = "#31688e",
    "unmarked_Kept_total" = "#35b779",
    "unmarked_Released_total" = "#d4be02"
  )
  
  # Filter data for the specific finescale fishery
  filtered_data <- plot_data %>% filter(finescale_fishery == finescale_fishery_name)
  filtered_model_data <- model_data %>% filter(finescale_fishery == finescale_fishery_name)
  
  #check if all catch_estimate values are zero for each status
  #wont want ribbon and line if all data are 0 like in figure 10
  has_nonzero <- filtered_data %>%
    group_by(status) %>%
    summarize(has_nonzero = any(catch_estimate != 0), .groups = "drop")
  
  # Create the plot
  facet_plot <- ggplot(filtered_data, aes_string(x = x_var, y = "catch_estimate", col = "status", fill = "status")) +
    geom_point() +
    theme_bw() +
    scale_size_continuous(range = c(1, 3)) +
    scale_colour_manual(values = status_colors, guide = "none") +
    scale_fill_manual(values = status_colors, guide = "none") +
    xlab("Creel summer catch estimate") +
    ylab("iREC-only catch estimate") +
    facet_wrap(~status,
               labeller = labeller(status = status_labels),
               scales = "free")
  
  # Conditionally add geom_line and geom_ribbon for statuses with non-zero data
  for (status in unique(filtered_data$status)) {
    if (has_nonzero %>% filter(status == !!status) %>% pull(has_nonzero)) {
      facet_plot <- facet_plot +
        geom_line(data = filtered_model_data %>% filter(status == !!status),
                  aes_string(y = "fit", x = x_var, col = "status")) +
        geom_ribbon(data = filtered_model_data %>% filter(status == !!status),
                    aes_string(y = "fit", x = x_var, ymin = "right_lwr", ymax = "right_upr", fill = "status"), 
                    alpha = 0.10)
    }
  }
  
  return(facet_plot)
}
```


#### Southern BC Summer Fisheries

*Note: the math inline is not rendering properly in the pdf*

The best model for Southern BC Summer Fisheries was one with a gamma distribution with a log link which included summer South Coast creel, marked and kept status, finescale fishery, and an interaction between summer creel and finescale fishery, creel summer and status, and status and finescale fishery:

$$
catch =creel.summer +fishery+status+creel.summer:fishery+ creel.summer:status + status:fishery
$$

This model parameterization allows for filtered creel + calibrated iREC catch in the whole summer period (months 5:9) to be predicted both independently by the unfiltered creel and logbook catch in the limited creel summer period (months 7:8), by finescale fishery, and by status (marked kept, marked released, unmarked kept, unmarked released). In addition, the effect of the creel summer period on catch can be modified by finescale fishery and status and the effect of status on catch can be modified by finescale fishery. Figure \@ref(fig:fig-south-sum-residuals) shows the qq plot residuals and a plot of the residuals against predicted values to detect patterns in residuals. While not demonstrating a flawless fit, the qq plots and residual plots showed minimal patterns and were optimized by this best-fit model chosen by AIC. The model fit plots for all models can be found in Appendix B.

Figure \@ref(fig:fig-jdf-summer-model) shows an example of the Summer model results in Juan de Fuca. Generally, for any given finescale fishery and status, as unfiltered creel and logbook catch in the limited creel summer period increases, so does filtered creel + calibrated iREC catch in the whole summer period. The model results plots for the remaining southern BC fisheries can be found in Appendix C.

```{r results example seasonal summer, results='asis', echo=FALSE}
#| label: fig-jdf-summer-model
#| fig-cap: "Juan de Fuca Summer fishery modelled relationship between concentrated summertime unfiltered creel estimate (months 7 and 8) and total catch estimate including iREC in summer months (5-9). Data points are yearly estimates from 2013 to 2023."

Summer_south<-Sport_mark_rate_finescale_combined %>%
  filter(YEAR %in% c(2013:2023))%>%
  filter(!str_detect(finescale_fishery, "CBC|NBC")) %>%
  filter(season %in% c("summer"))

Summer_south_no_nas<-Summer_south %>% drop_na(any_of(c("creel_plus_summer", "status", "finescale_fishery_old")))

Summer_model<- glm(formula = catch_estimate ~ finescale_fishery_old + status + creel_plus_summer:finescale_fishery_old + creel_plus_summer:status +
finescale_fishery_old:status + 1 + creel_plus_summer,  family=Gamma(link = "log"), data = Summer_south_no_nas)

#### Adding confidence intervals based on model to a dataframe for plotting purposes
#based on this blog: https://fromthebottomoftheheap.net/2018/12/10/confidence-intervals-for-glms/

family.set <- family(Summer_model)
ilink.family.set<- family.set$linkinv

mod<-Summer_model

ndata<-Summer_south_no_nas %>% group_by(status, finescale_fishery_old, finescale_fishery, season) %>%  tidyr::expand(creel_plus_summer = seq(0, max(creel_plus_summer), length=100))
  

## add the fitted values by predicting from the model for the new data
ndata<- add_column(ndata, fit = predict(mod, newdata = ndata, type = 'response'))
ndata<- bind_cols(ndata, setNames(as_tibble(predict(mod, ndata, se.fit = TRUE)[1:2]),
                                                   c('fit_link','se_link')))

ndata <- mutate(ndata,
                fit_resp  = ilink.family.set(fit_link),
                right_upr = ilink.family.set(fit_link + (2 * se_link)),
                right_lwr = ilink.family.set(fit_link - (2 * se_link)))

fishery_name_south<- sort(unique(Summer_south_no_nas$finescale_fishery))

i =1


plot <- create_facet_plot(finescale_fishery_name = fishery_name_south[i], 
                          x_var = "creel_plus_summer", 
                          plot_data = Summer_south_no_nas, 
                          model_data = ndata) +
  #changing the y lab
  ylab("IREC-included catch estimate")

plot

```

#### Northern BC AABM Summer Fisheries

The best model for Northern BC AABM Summer Fisheries was one with a gamma distribution with a log link which included summer historic data (Haida creel + logbook), status, and an interaction of these two terms:

$$ catch = historic.summer+status + historic.summer:status $$

This model parameterization allows for calibrated iREC catch in the whole summer period (months 5:9) to be predicted both independently by the unfiltered creel and logbook (historic) catch in the limited creel summer period (months 7:8) and by status. In addition, the effect of the creel and logbook (historic) summer period on catch is modified by status. Figure \@ref(fig:fig-nbcaabm-sum-residuals) shows the qq plot residuals and a plot of the residuals against predicted values to detect patterns in residuals. There are some noticeable patterns in the residuals here that could be improved, however at this time this is the best model fit to the data.

Figure \@ref(fig:fig-nbcaabm-summer-model) shows the summer model results in NBC AABM. As above, we see that for each status, as unfiltered creel and logbook catch in the limited creel summer period increases, so does calibrated iREC catch in the whole summer period.

```{r results NBC AABM summer, results='asis', echo=FALSE}
#| label: fig-nbcaabm-summer-model
#| fig-cap: "NBC AABM modelled results for Summer fishery"


Summer_north_aabm<-Sport_mark_rate_finescale_combined%>%
  filter(YEAR %in% c(2015:2023)) %>%
  filter(finescale_fishery_old == "NBC AABM S")%>%
  filter( season=="summer")

#Modelling comparisons need to be done on models with same # of NAs - so drop nas
Summer_north_aabm_no_nas<-Summer_north_aabm %>% drop_na(any_of(c("historic_summer", "status", "finescale_fishery_old", "season", "historic_effort")))

###Chosen model
Summer_north_aabm_model_gamma_spec<- glm(formula = catch_estimate + 1 ~ status + historic_summer:status + 1 + historic_summer,  family=Gamma(link = "log"), data = Summer_north_aabm_no_nas)

family.set <- family(Summer_north_aabm_model_gamma_spec)
ilink.family.set<- family.set$linkinv

mod<-Summer_north_aabm_model_gamma_spec

ndata<-Summer_north_aabm_no_nas %>% group_by(status, finescale_fishery_old, finescale_fishery, season) %>%  tidyr::expand(historic_summer = seq(0, max(historic_summer), length=100))


## add the fitted values by predicting from the model for the new data
ndata<- add_column(ndata, fit = predict(mod, newdata = ndata, type = 'response'))
ndata<- bind_cols(ndata, setNames(as_tibble(predict(mod, ndata, se.fit = TRUE)[1:2]),
                                                   c('fit_link','se_link')))

ndata <- mutate(ndata,
                fit_resp  = ilink.family.set(fit_link),
                right_upr = ilink.family.set(fit_link + (2 * se_link)),
                right_lwr = ilink.family.set(fit_link - (2 * se_link)))


fishery_name_north_aabm<- sort(unique(Summer_north_aabm_no_nas$finescale_fishery))

i=1

plot <- create_facet_plot(finescale_fishery_name = fishery_name_north_aabm[i], 
                          x_var = "historic_summer", 
                          plot_data = Summer_north_aabm_no_nas, 
                          model_data = ndata)

plot
```

#### Northern BC ISBM Summer Fisheries

The best model for Northern BC ISBM Summer Fisheries was one with a gamma distribution with a log link which included summer historic data (Area 3 and 4 Creel + logbook) and status, with no interaction of these terms.

$$ catch = historic.summer+status                                           $$

This model parameterization allows for calibrated iREC catch in the whole summer period (months 5:9) to be predicted both independently by the unfiltered Area 3 and 4 creel and logbook catch in the limited creel summer period (months 7:8) and by status. Figure \@ref(fig:fig-nbcisbm-sum-residuals) shows the qq plot residuals and a plot of the residuals against predicted values to detect patterns in residuals. The residuals vs. predicted values show no signicant patterns.

Figure \@ref(fig:fig-nbcisbm-summer-model) shows the summer model results in NBC ISBM. In NBC ISBM fisheries, the catch of marked fish in the summertime period is substantially less (0-1000 pieces) than the catch of unmarked fish (1000-6000 pieces). The model fits much better at the higher catch estimates of the unmarked fish, than the marked fish and since the best model did not include a term for interaction between status and creel summertime, the relationship is not modified by status.

```{r results NBC ISBM summer, results='asis', echo=FALSE}
#| label: fig-nbcisbm-summer-model
#| fig-cap: "NBC ISBM modelled results for Summer fishery"

### Data needed
Summer_north_isbm<-Sport_mark_rate_finescale_combined%>% filter(YEAR %in% c(2015:2023)) %>% filter(finescale_fishery_old == "NBC ISBM S")%>%
  filter(season %in% c("summer"))
Summer_north_isbm_no_nas<-Summer_north_isbm %>% drop_na(any_of(c("historic_summer", "status", "finescale_fishery_old")))
write_rds(Summer_north_isbm_no_nas, "Summer_north_isbm_no_nas.RDS")

#Chosen model
Summer_north_isbm_model_full_gamma_spec<- glm(formula = catch_estimate + 1 ~ status + 1 + historic_summer,  family=Gamma(link = "log"), data = Summer_north_isbm_no_nas)


family.set <- family(Summer_north_isbm_model_full_gamma_spec)
ilink.family.set<- family.set$linkinv

mod<-Summer_north_isbm_model_full_gamma_spec

ndata<-Summer_north_isbm_no_nas %>% group_by(status, finescale_fishery_old, finescale_fishery, season) %>%  tidyr::expand(historic_summer = seq(0, max(historic_summer), length=100))

## add the fitted values by predicting from the model for the new data
ndata<- add_column(ndata, fit = predict(mod, newdata = ndata, type = 'response'))
ndata<- bind_cols(ndata, setNames(as_tibble(predict(mod, ndata, se.fit = TRUE)[1:2]),
                                                   c('fit_link','se_link')))

ndata <- mutate(ndata,
                fit_resp  = ilink.family.set(fit_link),
                right_upr = ilink.family.set(fit_link + (2 * se_link)),
                right_lwr = ilink.family.set(fit_link - (2 * se_link)))

fishery_name_north_isbm<- sort(unique(Summer_north_isbm_no_nas$finescale_fishery))

i=1


plot <- create_facet_plot(finescale_fishery_name = fishery_name_north_isbm[i], 
                          x_var = "historic_summer", 
                          plot_data = Summer_north_isbm_no_nas, 
                          model_data = ndata)

plot
```

#### Southern BC Spring and Fall fisheries

The best model for Southern BC Spring and Fall fisheries was one with a gamma distribution with a log link which included summer creel, status, finescale fishery, season, and various interactions of these terms:

$$ catch = creel.summer+fishery+season+status+creel.summer:fishery+creel.summer:status+                                               fishery:season $$

This model parameterization allows for filtered calibrated iREC catch to be predicted both independently by the unfiltered creel and logbook catch in the limited creel summer period (months 7:8), by finescale fishery, by season (spring(months 1:4) or fall(10:12), and by status (marked kept, marked released, unmarked kept, unmarked released). In addition, the effect of the creel summer period on catch can be modified by finescale fishery and status and the effect of season on catch can be modified by finescale fishery. Figure \@ref(fig:fig-south-sf-residuals) shows the qq plot residuals and a plot of the residuals against predicted values to detect patterns in residuals. There are some noticeable patterns in the residuals here that could be improved, however at this time this is the best model fit to the data.

Figure \@ref(fig:fig-jdf-fall-model) shows an example of the Spring/Fall model results in Juan de Fuca Fall fisheries. This particular example shows a poorer fit to the data than some of the other fisheries (see Appendix C). However, the iREC catch estimated for the all months 10:12 is generally low, and without this model, it likely that the predicted catch in off-season fisheries would be 0 or close to zero if there was no creel during this period.

```{r results example seasonal spring and fall, results='asis', echo=FALSE}
#| label: fig-jdf-fall-model
#| fig-cap: "Juan de Fuca modelled results for Fall fishery"

Season_south_sf<-Sport_mark_rate_finescale_combined %>%
  filter(YEAR %in% c(2013:2023))%>%
  filter(!str_detect(finescale_fishery, "CBC|NBC")) %>%
  filter(season %in% c("spring", "fall"))

#Modelling comparisons need to be done on models with same # of NAs - so drop nas
Season_south_no_nas<-Season_south_sf %>% drop_na(any_of(c("creel_plus_summer", "status", "finescale_fishery_old", "season")))

Spring_fall_model<-  glm(formula =catch_estimate + 3 ~ finescale_fishery_old + season +   status + creel_plus_summer:finescale_fishery_old + creel_plus_summer:status +  finescale_fishery_old:season + 1 + creel_plus_summer,  family=Gamma(link = "log"), data = Season_south_no_nas)

family.set <- family(Spring_fall_model)
ilink.family.set<- family.set$linkinv

mod<-Spring_fall_model

ndata<-Season_south_no_nas %>% group_by(status, finescale_fishery_old, finescale_fishery, season) %>%  tidyr::expand(creel_plus_summer = seq(0, max(creel_plus_summer), length=100))
  

## add the fitted values by predicting from the model for the new data
ndata<- add_column(ndata, fit = predict(mod, newdata = ndata, type = 'response'))
ndata<- bind_cols(ndata, setNames(as_tibble(predict(mod, ndata, se.fit = TRUE)[1:2]),
                                                   c('fit_link','se_link')))

ndata <- mutate(ndata,
                fit_resp  = ilink.family.set(fit_link),
                right_upr = ilink.family.set(fit_link + (2 * se_link)),
                right_lwr = ilink.family.set(fit_link - (2 * se_link)))


fishery_name_south<- sort(unique(Season_south_no_nas$finescale_fishery))

i =1


plot <- create_facet_plot(finescale_fishery_name = fishery_name_south[i], 
                          x_var = "creel_plus_summer", 
                          plot_data = Season_south_no_nas, 
                          model_data = ndata)

plot

```

#### Northern BC AABM Spring and Fall Fisheries

The best model for Northern BC AABM Spring and Fall Fisheries was one with a gamma distribution with a log link which included summer historic data (Haida creel + logbook), season, status, and an interaction of status and creel.

$$ catch = historic.summer+season+status + historic.summer:status $$

This model parameterization allows for calibrated iREC catch to be predicted both independently by the unfiltered Haida creel and logbook catch in the limited creel summer period (months 7:8), by season, and by status. In addition, the effect of the creel and logbook (historic) summer period on catch is modified by status. Figure \@ref(fig:fig-nbcaabm-sf-residuals) shows the qq plot residuals and a plot of the residuals against predicted values to detect patterns in residuals. There are noticeable patterns in the residuals, but this was the best model tested.

Figure \@ref(fig:fig-nbcaabm-fall-model) shows an example of the Fall model results in NBC AABM. There is very little catch in Fall NBC AABM fisheries and therefore the models tend to predict a nominal small amount of additional fish in the fall, and a larger amount in the spring (see Appendix C).

```{r results example NBC AABM seasonal spring and fall, results='asis', echo=FALSE}
#| label: fig-nbcaabm-fall-model
#| fig-cap: "NBC AABM modelled results for Fall fishery"

### Data needed
Season_north_aabm<-Sport_mark_rate_finescale_combined%>% filter(YEAR %in% c(2015:2023)) %>% filter(finescale_fishery_old == "NBC AABM S") %>%
  filter(season %in% c("spring", "fall"))
Season_north_aabm_no_nas<-Season_north_aabm %>% drop_na(any_of(c("historic_summer", "status", "finescale_fishery_old", "season", "historic_effort")))

write_rds(Season_north_aabm_no_nas, "Season_north_aabm_no_nas.RDS")

###Chosen model
North_aabm_model<- glm(formula = catch_estimate + 1 ~ season + status + historic_summer:season + 1 + historic_summer,  family=Gamma(link = "log"), data = Season_north_aabm_no_nas)


family.set <- family(North_aabm_model)
ilink.family.set<- family.set$linkinv

mod<-North_aabm_model

ndata<-Season_north_aabm_no_nas %>% group_by(status, finescale_fishery_old, finescale_fishery, season) %>%  tidyr::expand(historic_summer = seq(0, max(historic_summer), length=100))


## add the fitted values by predicting from the model for the new data
ndata<- add_column(ndata, fit = predict(mod, newdata = ndata, type = 'response'))
ndata<- bind_cols(ndata, setNames(as_tibble(predict(mod, ndata, se.fit = TRUE)[1:2]),
                                                   c('fit_link','se_link')))

ndata <- mutate(ndata,
                fit_resp  = ilink.family.set(fit_link),
                right_upr = ilink.family.set(fit_link + (2 * se_link)),
                right_lwr = ilink.family.set(fit_link - (2 * se_link)))


fishery_name_north_aabm<- sort(unique(Season_north_aabm_no_nas$finescale_fishery))

i=1 

plot <- create_facet_plot(finescale_fishery_name = fishery_name_north_aabm[i], 
                          x_var = "historic_summer", 
                          plot_data = Season_north_aabm_no_nas, 
                          model_data = ndata)

plot

```

#### Northern BC ISBM Spring and Fall Fisheries

The best model for Northern BC ISBM Spring and Fall Fisheries was one with a gamma distribution with a log link which included summer historic data (Area 3 and 4 creel + logbook), season, status, and an interaction of season and status.

$$ catch = historic.summer+season+status+season:status $$

This model parameterization allows for calibrated iREC catch to be predicted both independently by the unfiltered Area 3 and 4 creel and logbook catch in the limited creel summer period (months 7:8), by season and by status. The effect of season was modified by status. Figure \@ref(fig:fig-nbcisbm-sf-residuals) shows the qq plot residuals and a plot of the residuals against predicted values to detect patterns in residuals.

Figure \@ref(fig:fig-nbcisbm-fall-model) shows an example of the model results in NBC ISBM fall fishery. The unmarked kept status fits the data the best since it has the largest catch. Generally, the iREC-only catch predicted in fall fisheries in NBC ISBM is fairly small.

```{r results example NBC ISBM seasonal spring and fall, results='asis', echo=FALSE}
#| label: fig-nbcisbm-fall-model
#| fig-cap: "NBC ISBM modelled results for Fall fishery"

Season_nbc_isbm<-Sport_mark_rate_finescale_combined%>% filter(YEAR %in% c(2015:2023)) %>% filter(finescale_fishery_old == "NBC ISBM S")%>%
  filter(season %in% c("spring", "fall"))

Season_north_isbm_no_nas<-Season_nbc_isbm %>% drop_na(any_of(c("historic_summer", "status", "finescale_fishery_old", "season")))


###Chosen model
nbc_isbm_model_full_gamma_spec<- glm(formula = catch_estimate + 1 ~ season + status + season:status + 1 + historic_summer,  family=Gamma(link = "log"), data = Season_north_isbm_no_nas)

family.set <- family(nbc_isbm_model_full_gamma_spec)
ilink.family.set<- family.set$linkinv

mod<-nbc_isbm_model_full_gamma_spec

ndata<-Season_north_isbm_no_nas %>% group_by(status, finescale_fishery_old, finescale_fishery, season) %>%  tidyr::expand(historic_summer = seq(0, max(historic_summer), length=100))

## add the fitted values by predicting from the model for the new data
ndata<- add_column(ndata, fit = predict(mod, newdata = ndata, type = 'response'))
ndata<- bind_cols(ndata, setNames(as_tibble(predict(mod, ndata, se.fit = TRUE)[1:2]),
                                                   c('fit_link','se_link')))

ndata <- mutate(ndata,
                fit_resp  = ilink.family.set(fit_link),
                right_upr = ilink.family.set(fit_link + (2 * se_link)),
                right_lwr = ilink.family.set(fit_link - (2 * se_link)))


fishery_name_north_isbm<- sort(unique(Season_north_isbm_no_nas$finescale_fishery))

i=1

plot <- create_facet_plot(finescale_fishery_name = fishery_name_north_isbm[i], 
                          x_var = "historic_summer", 
                          plot_data = Season_north_isbm_no_nas, 
                          model_data = ndata)

plot
```

#### Central BC annual fishery

The best model for the Central BC annual fishery was one with a gamma distribution with a log link which included historic estimates (logbook only) and status.

$$ catch = historic.summer+status  $$

This model parameterization allows for calibrated iREC catch to be predicted both independently by the logbook catch in the limited creel summer period (months 7:8) and by status. Figure \@ref(fig:fig-cbc-residuals) shows the qq plot residuals and a plot of the residuals against predicted values to detect patterns in residuals. There were minimal patterns in the residuals.

Figure \@ref(fig:fig-cbc-model) shows the CBC model results. Generally for low catch estimates a flat line is predicted, but for unmarked Kept fish, the iREC estimate is an increasing function of summertime logbook catch.

```{r results CBC model, results='asis', echo=FALSE}
#| label: fig-cbc-model
#| fig-cap: "CBC modelled results for year round fishery"

Season_cbc_isbm<-Sport_mark_rate_finescale_combined%>% filter(YEAR %in% c(2015:2023)) %>% filter(finescale_fishery_old == "CBC S")

#Modelling comparisons need to be done on models with same # of NAs - so drop nas
Season_cbc_isbm_no_nas<-Season_cbc_isbm %>% drop_na(any_of(c("historic_summer", "status")))

#Chosen model:
cbc_isbm_model<- glm(formula = catch_estimate + 1 ~  status + 1 + historic_summer,  family=Gamma(link = "log"), data = Season_cbc_isbm_no_nas)

family.set <- family(cbc_isbm_model)
ilink.family.set<- family.set$linkinv

mod<-cbc_isbm_model

ndata<-Season_cbc_isbm_no_nas %>% group_by(status, finescale_fishery_old, finescale_fishery, season) %>%  tidyr::expand(historic_summer = seq(0, max(historic_summer), length=100))

## add the fitted values by predicting from the model for the new data
ndata<- add_column(ndata, fit = predict(mod, newdata = ndata, type = 'response'))
ndata<- bind_cols(ndata, setNames(as_tibble(predict(mod, ndata, se.fit = TRUE)[1:2]),
                                                   c('fit_link','se_link')))

ndata <- mutate(ndata,
                fit_resp  = ilink.family.set(fit_link),
                right_upr = ilink.family.set(fit_link + (2 * se_link)),
                right_lwr = ilink.family.set(fit_link - (2 * se_link)))

fishery_name_cbc_isbm<- sort(unique(Season_cbc_isbm_no_nas$finescale_fishery))

i=1

plot <- create_facet_plot(finescale_fishery_name = fishery_name_cbc_isbm[i], 
                          x_var = "historic_summer", 
                          plot_data = Season_cbc_isbm_no_nas, 
                          model_data = ndata) +
  xlab("Logbook summer catch estimate")

plot

```

\clearpage

### Model validation using sport head recoveries

We used the sport head recovery program to validate the model results.

```{r results Loading packages, useful functions, echo=FALSE}

#load packages
library(dplyr)
library(readr)
library(ggplot2)
library(ROracle)

#utils
"%notin%" <- Negate("%in%")
sport_catch <- Sport_mark_rate_finescale_combined
head_df <-  pacRecCatch::get_head_totals()

lm_eqn <- function(df){
  m <- lm(head_total ~ catch_estimate_predicted + 0, df)
  
  eq <- substitute(italic(y) == a %.% italic(x)*","~~italic(r)^2~"="~r2*"," ~~italic(n)*"="~df_n,
                   list(a = format(unname(coef(m)[1]), digits = 3),
                        b = format(unname(coef(m)[2]), digits = 3),
                        r2 = format(summary(m)$r.squared, digits = 3),
                        df_n = nrow(df)))
  as.character(as.expression(eq));
}

models_combined2 <-
  models_combined |>
  mutate(finescale_fishery = if_else(grepl("NWCVI|SWCVI", finescale_fishery), 
                                     trimws(gsub(" ISBM|AABM", "", finescale_fishery)),
                                     finescale_fishery)) |>
  group_by(YEAR, status, finescale_fishery, season, mark_status, kept_status) |>
  summarize(catch_estimate_predicted = sum(catch_estimate_predicted, na.rm=TRUE),
            .groups = "drop")

head_df <-
  head_df |>
  mutate(region = if_else(grepl("NWCVI|SWCVI", region), 
                          trimws(gsub(" ISBM|AABM", "", region)),
                          region)) |>
  group_by(year, region) |>
  summarize(head_total = sum(head_total, na.rm=TRUE),
            .groups = "drop")

head_catch_df <-
  models_combined2 |>
  filter(status == "marked_Kept_total") |>
  full_join(head_df, c(YEAR="year", finescale_fishery = "region")) |>
  mutate(YEAR = as.integer(YEAR),
         submit_rate = head_total/catch_estimate_predicted) |>
  filter(catch_estimate_predicted > 50)

head_catch_model_df <-
  head_catch_df |>
  filter(catch_estimate_predicted > 0, 
         coalesce(head_total, 0) > 0,
         coalesce(catch_estimate_predicted,0) > 0)

```

*Note: sentence here about what the plots show*

Figure \@ref(fig:fig-heads-kept-current) shows ...

```{r results Head to Kept Mark Catch, echo=FALSE}
#| label: fig-heads-kept-current
#| fig-cap: "Chinook Heads to Clipped Catch"

ggplot(data = head_catch_model_df, aes(x=catch_estimate_predicted,
                                       y=head_total)) +
  geom_point(size=2) +
  geom_smooth(method='lm', formula= y~x + 0) +
  geom_text(x = 500, y = 5000, label = lm_eqn(head_catch_model_df), parse = TRUE, hjust=0, vjust=0) +
  ggtitle("Chinook Head to Clipped Catch") +
  xlab("Chinook Kept Adclipped Catch") + 
  ylab("Chinook Head Recoveries")+
  theme_bw()


```

Figure \@ref(fig:fig-heads-kept-preirec) shows ...

```{r results Pre iRec Head to Kept Mark Catch, echo=FALSE}
#| label: fig-heads-kept-preirec
#| fig-cap: "Before iREC Chinook Heads to Clipped Catch"

pre_irec_catch_model_df <- 
  head_catch_model_df |>
  filter(YEAR < 2013)

eq_y_pos <- max(pre_irec_catch_model_df$head_total, na.rm=0) * 0.9

ggplot(data = pre_irec_catch_model_df,
       aes(x=catch_estimate_predicted, y=head_total)) +
  geom_point(size=2) +
  geom_smooth(method='lm', formula= y~x + 0) +
  geom_text(x = 500, y = eq_y_pos, label = lm_eqn(pre_irec_catch_model_df), parse = TRUE, hjust=0, vjust=0) +
  ggtitle("Before iRec Chinook Head to Clipped Catch") +
  xlab("Chinook Kept Adclipped Catch") + 
  ylab("Chinook Head Recoveries")+theme_bw()


```

Figure \@ref(fig:fig-heads-kept-postirec) shows ...

```{r results Post iRec Head to Kept Mark Catch, echo=FALSE}
#| label: fig-heads-kept-postirec
#| fig-cap: "iREC Chinook Heads to Clipped Catch"


post_irec_catch_model_df <- 
  head_catch_model_df |>
  filter(YEAR >= 2013)

eq_y_pos <- max(post_irec_catch_model_df$head_total, na.rm=0) * 0.9

ggplot(data = post_irec_catch_model_df,
       aes(x=catch_estimate_predicted, y=head_total)) +
  geom_point(size=2) +
  geom_smooth(method='lm', formula= y~x + 0) +
  geom_text(x = 500, y = eq_y_pos, label = lm_eqn(post_irec_catch_model_df), parse = TRUE, hjust=0, vjust=0) +
  ggtitle("iRec Chinook Head to Clipped Catch") +
  xlab("Chinook Kept Adclipped Catch") + 
  ylab("Chinook Head Recoveries")+theme_bw()

```

Figure \@ref(fig:fig-fishery-rates) shows ...

```{r results Fishery Rates, echo=FALSE}
#| label: fig-fishery-rates
#| fig-cap: "Fishery Rates"

ggplot(data = head_catch_model_df, aes(x=YEAR, y=submit_rate, color=finescale_fishery)) +
  geom_line(linewidth = 2)

```

Figure \@ref(fig:fig-fishery-rates-preirec) shows ...

```{r results pre IRec Fishery Rates, echo=FALSE}
#| label: fig-fishery-rates-preirec
#| fig-cap: "pre Irec Fishery Rates"


ggplot(data = pre_irec_catch_model_df, aes(x=YEAR, y=submit_rate, color=finescale_fishery)) +
  geom_line(linewidth = 2)

```

\clearpage

## Incorporation of both sets of revised estimates in Chinook Technical Committee processes

Catch estimates are inputs to the exploitation rate analysis in two places. First, kept and marked catch estimates are used to expand Coded Wire Tag (CWT) observations from the Sport Head Recovery Program to CWT estimates uploaded to RMIS. Canada is in the process of revising CWT estimates based on revised catch and plans to publish to RMIS in time for the 2025 ERA process.

### Catch and Escapement Reporting Kept and Released Catch

-   *Note: this text is from the memo - see parts about NBC and Georgia strait ... maybe take out???*

The revised estimates will be incorporated into CTC reports starting in 2025. Both kept and released catch estimates are typically reported in the Catch and Escapement report by ERA fishery. Here we plot the difference between the revised kept (Figure \@ref(fig:fig-cande-kept)) and released (Figure \@ref(fig:fig-cande-released)) catch estimates and those recently reported in the 2024 C&E report. Again, we see that the revised catch estimates were generally higher than previously reported estimates that didn't include iREC information. In some fisheries, iREC information has been included in recent years (e.g., since 2018 in Georgia Strait Sport), but our revised estimates incorporate iREC in a standardized way across all fisheries. The largest changes in kept catch occurred in Central BC where iREC has not been previously incorporated, but the inclusion of iREC more than doubles recent estimates. Other large changes occur in Georgia Strait sport before 2012 (post 2013 iREC has previously been incorporated in the reports) and NBC AABM sport in 2005-2009. In these last two cases, the revised catch is not better aligned with the number of sport head recoveries than previous estimates. We will be investigating these changes further before applying this data to CWT estimates.

```{r results CandEkept, results='asis', echo=FALSE}
#| label: fig-cande-kept
#| fig-cap: "Revised (blue) and previously reported (green) kept catch estimates from 2005-2023. Revised estimates prior to 2012 (vertical line) are from modelled data, whereas 2013 onwards is observed data. "


cnr_canada_sport<-read.csv("data/cnr_canada_sport.csv") %>% as_tibble() %>% filter(year>2004)

fishery_map<-models_combined %>% dplyr::select(finescale_fishery_old, finescale_fishery) %>%
  mutate(erafishery = case_when(
    finescale_fishery_old %in% c("NWCVI S AABM", "SWCVI S AABM") ~ "WCVI AABM S",
    finescale_fishery_old %in% c("NGS S", "SGS S") ~  "GEO ST S",
    finescale_fishery_old == "CA JDF S" ~ "BC JF S",
    finescale_fishery_old %in%  c("NWCVI S ISBM", "SWCVI S ISBM") ~ "WCVI ISBM S",
    TRUE ~ finescale_fishery_old
  )) %>% unique()

cnr_canada_sport<-cnr_canada_sport %>% left_join(fishery_map) %>% rename(YEAR=year)

Sport_mark_rate_mrr<- Sport_mark_rate_mrr_corrected %>% left_join(cnr_canada_sport)
Sport_mark_rate_mrr<-Sport_mark_rate_mrr %>% mutate(Kept_total = marked_Kept_total + unmarked_Kept_total,
                                                    Released_total = marked_Released_total + unmarked_Released_total)


cnr_canada_sport_short<- cnr_canada_sport %>% dplyr::select(-finescale_fishery, -finescale_fishery_old) %>% unique()

Sport_mark_rate_mrr_sum<-Sport_mark_rate_mrr %>% dplyr::select(-Kept, -Released, -Release_rate) %>% group_by(erafishery, YEAR) %>%   summarise_if(is.numeric, sum, na.rm = TRUE)
Sport_mark_rate_mrr_sum<-Sport_mark_rate_mrr_sum  %>% left_join(cnr_canada_sport_short)

rec_summary<-read.csv("data/rec_summary_2005-2023.csv") %>% as_tibble()
Sport_mark_rate_mrr_sum<-Sport_mark_rate_mrr_sum  %>% left_join(rec_summary)
Sport_mark_rate_mrr_sum<-Sport_mark_rate_mrr_sum %>% filter(!is.na(erafishery))

## Kept only
k<-ggplot() +
  geom_point(data=Sport_mark_rate_mrr_sum, aes(y=Kept_total, x=YEAR, col="lightblue4")) + geom_line(data=Sport_mark_rate_mrr_sum, aes(y=Kept_total, x=YEAR, col="lightblue4"))+
  geom_point(data=Sport_mark_rate_mrr_sum, aes(y=total_kept, x=YEAR, col="lightgreen")) + geom_line(data=Sport_mark_rate_mrr_sum, aes(y=total_kept, x=YEAR, col="lightgreen"))+
 # geom_point(data=Sport_mark_rate_mrr_sum, aes(y=Kept, x=YEAR, col="darkgreen")) + geom_line(data=Sport_mark_rate_mrr_sum, aes(y=Kept, x=YEAR, col="darkgreen"))+

  scale_color_manual(values=c("lightblue4", "lightgreen"),  labels = c("Revised estimates", "2024 C&E Report"))+
  theme(legend.position="bottom")+
  ylab("Kept Catch")+
  facet_wrap(~erafishery, scales = "free", ncol=4)+
  theme_bw()+ geom_vline(xintercept = 2012)+
  labs(col = "Data source")

print(k)

```

The largest changes in released catch occurred in Central BC where previously very few releases were counted. This is because lodges in CBC do not report released catch, whereas iREC allows for released catch to be recorded. We also now predict releases prior to 2012 in Georgia Strait and NBC ISBM and BC Juan de Fuca, where previously very few releases were recorded. The other fisheries had recorded releases but the revised estimates which include iREC increase the number of these released fish.

```{r results CandEreleased, results='asis', echo=FALSE}
#| label: fig-cande-released
#| fig-cap: "Revised (blue) and previously reported (green) released catch estimates from 2005-2023. Revised estimates prior to 2012 (vertical line) are from modelled data, whereas 2013 onwards is observed data. "

cwt_est_filename <- "data/cwt_est_by_fishery.sql"
cwt_est_sql <- readChar(cwt_est_filename, file.info(cwt_est_filename)$size)

local_camp <- ctcUtil::open_camp_connection("camp_local.yaml")
server_camp <- ctcUtil::open_camp_connection("camp_server.yaml")

local_cwt_est <- 
  dbGetQuery(local_camp, cwt_est_sql) |>
  mutate(fishery = paste(fishery_id, " - ", fishery_name))

server_cwt_est <- 
  dbGetQuery(server_camp, cwt_est_sql) |>
  mutate(fishery = paste(fishery_id, " - ", fishery_name))

dbDisconnect(local_camp)
dbDisconnect(server_camp)


## Released only
ggplot() +
  geom_point(data=local_cwt_est, aes(y=cwt_estimate, x=run_year, col="lightblue4")) + 
  geom_line(data=local_cwt_est, aes(y=cwt_estimate, x=run_year, col="lightblue4"))+
  geom_point(data=server_cwt_est, aes(y=cwt_estimate, x=run_year, col="lightgreen")) + 
  geom_line(data=server_cwt_est, aes(y=cwt_estimate, x=run_year, col="lightgreen"))+
  scale_color_manual(values=c( "lightblue4", "lightgreen"),  labels = c("Revised estimates", "2024 CWT Estimates"))+
  theme(legend.position="bottom")+
  ylab("CWT Estimate (All Indicators)")+
  xlab("Run Year")+
  facet_wrap(~fishery, scales = "free", ncol=4)+
  theme_bw() + 
  geom_vline(xintercept = 2012)+
  labs(col = "Data source")

```

### Updating CWT estimates

-   *CWT results here*


```{r results indcwtest, results='asis', echo=FALSE}
#| label: fig-indcwtest
#| fig-cap: "Release rates at the finescale fishery level, over time from 2005 to 2023. Light blue lines are release rates of unmarked fish and dark blue lines are release rates of marked fish, from revised data. Green lines are release rates (regardless of mark status) used in the 2024 CNR files to the ERA."



Sport_mark_rate_mrr<-Sport_mark_rate_mrr %>% filter(!is.na(erafishery))

mu<-ggplot() +
  geom_point(data=Sport_mark_rate_mrr, aes(y=(1-ukr), x=YEAR, col="lightblue")) + geom_line(data=Sport_mark_rate_mrr, aes(y=1-ukr, x=YEAR, col="lightblue"))+
  geom_point(data=Sport_mark_rate_mrr, aes(y=mrr, x=YEAR, col="lightblue4")) + geom_line(data=Sport_mark_rate_mrr, aes(y=mrr, x=YEAR, col="lightblue4"))+
  geom_point(data=Sport_mark_rate_mrr, aes(y=Release_rate, x=YEAR, col="lightgreen")) + geom_line(data=Sport_mark_rate_mrr, aes(y=Release_rate, x=YEAR, col="lightgreen"))+
  scale_color_manual(values=c("lightblue", "lightblue4", "lightgreen"),  labels = c("Revised Unmarked Release Rate", "Revised Marked Release Rate", "2024 CNR Release Rate"))+
  theme(legend.position="bottom")+
  ylab("Proportion")+
  facet_wrap(~finescale_fishery)+
  theme_bw()+ geom_vline(xintercept = 2012)+
  labs(col="Data source")+
  theme(legend.position = "bottom")

print(mu)
```


### Updating Chinook non-retention (release) estimates

-   *MRR/UKR results here compared to CNR file (Fig 5 of the memo)*

Kept and released catch estimates are incorporated for most sport fisheries into the Chinook non-retention process in the ERA. This year the ERA is switching from a model that only accounts Chinook non-retention without selectively to non-retention by mark status, therefore the applicable rates in the ERA that are affected by the revised catch estimates are the marked released rate (MRR) and unmarked kept rate (UKR). We calculated the MR and UK rates at the PFMA and month level and then used a weighted average based on total catch estimate per area and month to generate an MR and UK rate for each finescale fishery. For simplicity we will show the unmarked release rate URR (1-UKR), although UKR is used in the equations. We can compare these marked and unmarked release rates based on revised catch estimates to release rates generated by the ratio between kept and released fish in the CNR file used in the 2024 ERA (Figure \@ref(fig:fig-mrrukr)). In the revised estimates, we allow release rate to vary by season, whereas in the past, finescale fisheries were not split into seasons and therefore release rates in each ERA fishery applied to all seasons.

We can see that some fisheries have been accounting for releases since 2005, while other fisheries only more recently incorporated release information . With the exception of Juan de Fuca, which did have mark-selective fisheries before 2012, all other sport fisheries were non-selective before 2013. Since the data is modelled, we did not want to bias the previous non-selective fisheries by allowing for selectivity, therefore we have fixed the MRR and URR rates to be equal in the modelled data, by calculating a single release rate for marked and unmarked fish combined. After 2013, the data is observed and therefore allowed to vary selectively even if no specific mark selective fishery was imposed. When MRR and URR are identical, this indicates non-selectivity. If MRR is higher than URR, this indicates marked fish are released at a higher rate than unmarked fish, which would be indicative of selecting for unmarked fish. If URR is higher than MRR, then marked fish are released at a lower rate than unmarked fish, indicating mark selectivity. Generally, the MRR and URR results suggest that releases are occurring but there is no strong, consistent mark selectivity to the releases. This aligns with MSF regulations that are very limited in space and time and are only beginning to be rolled out across a small number of sport fisheries.

```{r results mrrukr, results='asis', echo=FALSE}
#| label: fig-mrrukr
#| fig-cap: "Release rates at the finescale fishery level, over time from 2005 to 2023. Light blue lines are release rates of unmarked fish and dark blue lines are release rates of marked fish, from revised data. Green lines are release rates (regardless of mark status) used in the 2024 CNR files to the ERA."


Sport_mark_rate_mrr<-Sport_mark_rate_mrr %>% filter(!is.na(erafishery))

mu<-ggplot() +
  geom_point(data=Sport_mark_rate_mrr, aes(y=(1-ukr), x=YEAR, col="lightblue")) + geom_line(data=Sport_mark_rate_mrr, aes(y=1-ukr, x=YEAR, col="lightblue"))+
  geom_point(data=Sport_mark_rate_mrr, aes(y=mrr, x=YEAR, col="lightblue4")) + geom_line(data=Sport_mark_rate_mrr, aes(y=mrr, x=YEAR, col="lightblue4"))+
  geom_point(data=Sport_mark_rate_mrr, aes(y=Release_rate, x=YEAR, col="lightgreen")) + geom_line(data=Sport_mark_rate_mrr, aes(y=Release_rate, x=YEAR, col="lightgreen"))+
  scale_color_manual(values=c("lightblue", "lightblue4", "lightgreen"),  labels = c("Revised Unmarked Release Rate", "Revised Marked Release Rate", "2024 CNR Release Rate"))+
  theme(legend.position="bottom")+
  ylab("Proportion")+
  facet_wrap(~finescale_fishery)+
  theme_bw()+ geom_vline(xintercept = 2012)+
  labs(col="Data source")+
  theme(legend.position = "bottom")

print(mu)
```
