`r if(knitr:::is_latex_output()) '% begin csasdown appendix'` `r if(!knitr:::is_latex_output()) '# (APPENDIX) Appendix {-}'`

\clearpage

# Stratification Mapping

```{r methods strattab, echo=FALSE, message=FALSE, warning=FALSE}
#| label: strattab

strat_table <- 
  sport_catch_area |> 
  distinct(finescale_fishery, area, month) |>
  arrange(finescale_fishery,  area, month)

fishery_map <-
  sport_catch_area |>
  distinct(region, management, finescale_fishery) |>
  mutate(erafishery = case_when(
    region %in% c("SWCVI", "NWCVI") & management == "AABM" ~ "WCVI AABM S",
    region %in% c("NGS", "SGS") ~  "GEO ST S",
    region == "JDF" ~ "BC JF S",
    region == "CBC" ~ "CENTRAL S",
    region == "JNST" ~ "JNST S",
    region %in% c("SWCVI", "NWCVI") & management == "ISBM" ~ "WCVI ISBM S",
    region == "NC" & management == "ISBM" ~ "NBC ISBM S",
    region == "NC" & management == "AABM" ~ "NBC AABM S",
    region == "TSWCVI" ~ "SWCVI TERMINAL",
    .default = NA_character_)) |>
  select(finescale_fishery, erafishery) |>
  distinct()

strat_table <- 
  strat_table |>
  left_join(fishery_map, by = "finescale_fishery") |>
  arrange(erafishery) |> 
  relocate(erafishery) |>
  group_by(erafishery, finescale_fishery, area) |>
  summarize(month_category = paste0(min(month), " to ", max(month)),
            .groups = "drop") |>
  distinct() |> 
  arrange(erafishery, finescale_fishery, area, month_category) |>
  rename("ERA Fishery" = erafishery,  
         "Finescale Fishery" = finescale_fishery, 
         "PFMA" = area,
         "Months" = month_category)
  

csas_table(strat_table, format = "latex")
#strat_table %>%
#  kableExtra::kable("latex", 
#                    escape = FALSE,
#                    caption = "Stratification mapping",
#                    align = "l") #%>%
#  kableExtra::kable_classic(full_width = F, html_font = "Cambria") %>%
#  kableExtra::kable_styling(bootstrap_options = c("bordered")) %>%
 # kableExtra::collapse_rows(columns = 1:3, valign = "middle")


```

# Revised Estimates 2005-2023 {#app:first-appendix}

```{r m plots, results='asis', echo=FALSE}
#| label: fig-catch-revised-1-appendix
#| fig-cap: "Revised yearly kept catch estimates"

### make this by finescale fishery old... sum up. 
models_combined_old<-
  sport_catch_models$model_catch |>
  filter(region %notin% c("CBC", "NC")) |>
  mutate(region_mgmt = if_else(region %in% c("SWCVI", "NWCVI"),
                               paste(region, management),
                               region)) |>
  group_by(year, kept_status, pred_cat, region_mgmt) |> 
  summarise(across(where(is.double), sum, na.rm = TRUE), .groups = "drop")


fishery_name_south <- sort(unique(models_combined_old$region_mgmt))


for (i in 1:length(fishery_name_south)){
  graph_data <- 
    models_combined_old  %>% 
    filter(region_mgmt == fishery_name_south[i],
           between(year, 2005, 2023),
           kept_status == "kept") %>%
    select(year, creel_unfiltered_plus, catch_estimate_predicted) %>%
    pivot_longer(c(creel_unfiltered_plus, catch_estimate_predicted),
                 names_to = "estimate_type",
                 values_to = "catch_estimate")
  
  m <- ggplot(graph_data, aes(y = catch_estimate,
                              x = year,
                              shape = estimate_type,
                              linetype = estimate_type))+
    geom_point(size = 2.5,
               colour = "#440154")+
    geom_line(colour = "#440154") +
    scale_shape_manual(values = c(1, 16),
                       labels = c("iREC included", "Unfiltered creel and logbook")
    ) +
    scale_linetype_manual(values = c(2, 1),
                          labels = c("iREC included", "Unfiltered creel and logbook")
    ) +
    scale_x_continuous(breaks = seq.int(2005, 2023, by = 2)) +
    ggtitle(paste(fishery_name_south[i])) + 
    theme_bw() + 
    ylab("Kept catch estimate") + 
    xlab("Year") +
    labs(linetype = "Catch Estimate", shape = "Catch Estimate")

  print(m)
}
```

```{r m plots, results='asis', echo=FALSE}
#| label: fig-catch-revised-2-appendix
#| fig-cap: "revised yearly catch estimates"



### make this by finescale fishery old... sum up. 
models_combined_old2 <-
  sport_catch_models$model_catch |>
  filter(region %in% c("CBC", "NC")) |>
  mutate(region_mgmt = if_else(region == "NC",
                               paste(region, management),
                               region)) |>
  group_by(year, kept_status, pred_cat, region_mgmt) |> 
  summarise(across(where(is.double), sum, na.rm = TRUE), .groups = "drop")

fishery_name_north<- sort(unique(models_combined_old2$region_mgmt))

for (i in 1:length(fishery_name_north)) {
  graph_data <- 
    models_combined_old2  %>% 
    filter(region_mgmt == fishery_name_north[i],
           between(year, 2005, 2023),
           kept_status == "kept") %>%
    select(year, historic_plus, catch_estimate_predicted) %>%
    pivot_longer(c(historic_plus, catch_estimate_predicted),
                 names_to = "estimate_type",
                 values_to = "catch_estimate")
  
  m <- ggplot(graph_data, aes(y = catch_estimate,
                              x = year,
                              shape = estimate_type,
                              linetype = estimate_type)) +
    geom_point(size = 2.5,
               colour = "#440154")+
    geom_line(colour = "#440154") +
    scale_shape_manual(values = c(1, 16),
                       labels = c("iREC included", "Historic")
    ) +
    scale_linetype_manual(values = c(2, 1),
                          labels = c("iREC included", "Historic")
    ) +
    scale_x_continuous(breaks = seq.int(2005, 2023, by = 2)) +
    ggtitle(paste(fishery_name_north[i])) + 
    theme_bw() + 
    ylab("Kept catch estimate") + 
    xlab("Year") +
    labs(linetype = "Catch Estimate", shape = "Catch Estimate")
  
  print(m)
}
```

\clearpage

# Model Residuals {#app:second-appendix}

```{r Modelling summer subsetting appendix, message=FALSE, warning=FALSE, results='hide', echo=FALSE}
#| label: fig-south-sum-residuals
#| fig-cap: "Validation plots for BC South Summer model"

res_gam <- simulateResiduals(sport_catch_models$model_list$south_summer, plot = T, quantreg=T)
```

```{r Modelling spring and fall subsetting appendix, message=FALSE, warning=FALSE, results='hide', echo=FALSE}
#| label: fig-south-sf-residuals
#| fig-cap: "Validation plots for BC South Spring and Fall model"

res_gam <- simulateResiduals(sport_catch_models$model_list$south_season, plot = T, quantreg=T)

```

```{r Modelling summer nbc aabm subsetting appendix, message=FALSE, warning=FALSE, results='hide', echo=FALSE}
#| label: fig-nbcaabm-sum-residuals
#| fig-cap: "Validation plots for NBC AABM Summer model"

res_gam <- simulateResiduals(sport_catch_models$model_list$north_aabm_summer, plot = T, quantreg=T)

```

```{r Modelling NBC AABM spring and fall subsetting appendix, message=FALSE, warning=FALSE, results='hide', echo=FALSE}
#| label: fig-nbcaabm-sf-residuals
#| fig-cap: "Validation plots for NBC AABM Spring and Fall model"

res_gam <- simulateResiduals(sport_catch_models$model_list$north_aabm_season, plot = T, quantreg=T)

```

```{r Modelling summer nbc isbm subsetting appendix, message=FALSE, warning=FALSE, results='hide', echo=FALSE}
#| label: fig-nbcisbm-sum-residuals
#| fig-cap: "Validation plots for NBC ISBM Summer model"

res_gam <- simulateResiduals(sport_catch_models$model_list$north_isbm_summer, plot = T, quantreg=T)

```

```{r Modelling NBC ISBM spring and fall subsetting appendix, message=FALSE, warning=FALSE, results='hide', echo=FALSE}
#| label: fig-nbcisbm-sf-residuals
#| fig-cap: "Validation plots for NBC ISBM Spring and Fall model"

res_gam <- simulateResiduals(sport_catch_models$model_list$north_isbm_season, plot = T, quantreg=T)

```

```{r Modelling CBCsubsetting appendix, message=FALSE, warning=FALSE, results='hide', echo=FALSE}
#| label: fig-cbc-residuals
#| fig-cap: "Validation plots for CBC annual model"

res_gam <- simulateResiduals(sport_catch_models$model_list$central_isbm, plot = T, quantreg=T)

```

\clearpage

# Model Output {#app:third-appendix}

```{r appendix_plotting_function, include = FALSE}
#plotting function that will be used for the next few sections
create_facet_plot <- function(finescale_fishery_name, x_var, plot_data, model_data) {
  # Labels for facets
  status_labels <- c(
    "marked_kept_total" = "Marked Kept Total",
    "marked_released_total" = "Marked Released Total",
    "unmarked_Kept_total" = "Unmarked Kept Total",
    "unmarked_Released_total" = "Unmarked Released Total"
  )
  
  # Colors for status
  status_colors <- c(
    "marked_kept_total" = "#440154", 
    "marked_released_total" = "#31688e",
    "unmarked_Kept_total" = "#35b779",
    "unmarked_Released_total" = "#d4be02"
  )
  
  # Filter data for the specific finescale fishery
  filtered_data <- plot_data %>% filter(finescale_fishery == finescale_fishery_name)
  filtered_model_data <- model_data %>% filter(finescale_fishery == finescale_fishery_name)
  
  #check if all catch_estimate values are zero for each status
  #wont want ribbon and line if all data are 0 like in figure 10
  has_nonzero <- filtered_data %>%
    group_by(status) %>%
    summarize(has_nonzero = any(catch_estimate != 0), .groups = "drop")
  
  # Create the plot
  facet_plot <- ggplot(filtered_data, aes_string(x = x_var, y = "catch_estimate", col = "status", fill = "status")) +
    geom_point() +
    theme_bw() +
    scale_size_continuous(range = c(1, 3)) +
    scale_colour_manual(values = status_colors, guide = "none") +
    scale_fill_manual(values = status_colors, guide = "none") +
    xlab("Creel summer catch estimate") +
    ylab("Calibrated iREC-only catch estimate") +
    facet_wrap(~status,
               labeller = labeller(status = status_labels),
               scales = "free")
  
  # Conditionally add geom_line and geom_ribbon for statuses with non-zero data
  for (status in unique(filtered_data$status)) {
    if (has_nonzero %>% filter(status == !!status) %>% pull(has_nonzero)) {
      facet_plot <- facet_plot +
        geom_line(data = filtered_model_data %>% filter(status == !!status),
                  aes_string(y = "fit", x = x_var, col = "status")) +
        geom_ribbon(data = filtered_model_data %>% filter(status == !!status),
                    aes_string(y = "fit", x = x_var, ymin = "right_lwr", ymax = "right_upr", fill = "status"), 
                    alpha = 0.10)
    }
  }
  
  return(facet_plot)
}
```

## Southern BC Summer fisheries

```{r forloop seasonal summer appendix, results='asis', echo=FALSE}
south_summer_model <- sport_catch_models$model_list$south_summer
south_summer_no_nas <- south_summer_model$data

family_set <- family(south_summer_model)
ilink_family_set<- family_set$linkinv


ndata <-
  south_summer_no_nas %>% 
  group_by(status, finescale_fishery, season) %>%  
  tidyr::expand(creel_plus_summer = seq(0, max(creel_plus_summer), length=100)) %>%
  
  
  ## add the fitted values by predicting from the model for the new data
  add_column(fit = predict(south_summer_model, 
                           newdata = ., 
                           type = 'response')) %>%
  bind_cols(setNames(as_tibble(predict(south_summer_model, 
                                       ., 
                                       se.fit = TRUE)[1:2]),
                     c('fit_link','se_link'))) %>%
  mutate(fit_resp  = ilink_family_set(fit_link),
         right_upr = ilink_family_set(fit_link + (2 * se_link)),
         right_lwr = ilink_family_set(fit_link - (2 * se_link)))

fishery_name_south <- sort(unique(south_summer_no_nas$finescale_fishery))

for (i in 1:length(fishery_name_south)){
  
  plot <- create_facet_plot(finescale_fishery_name = fishery_name_south[i], 
                            x_var = "creel_plus_summer", 
                            plot_data = south_summer_no_nas, 
                            model_data = ndata) +
    ggtitle(paste(fishery_name_south[i])) + 
    #changing the y lab
    ylab("IREC-included catch estimate")
  
  print(plot)
}
```

## Southern BC Spring and Fall fisheries

```{r forloop seasonal spring and fall appendix, results='asis', echo=FALSE}

south_season_model <- sport_catch_models$model_list$south_season
south_season_no_nas <- south_season_model$data

family_set <- family(south_season_model)
ilink_family_set<- family_set$linkinv

ndata <-
  south_season_no_nas %>% 
  group_by(status, region_mgmt, finescale_fishery, season) %>%  
  tidyr::expand(creel_plus_summer = seq(0, max(creel_plus_summer), length=100)) %>%
  ## add the fitted values by predicting from the model for the new data
  add_column(fit = predict(south_season_model, newdata = ., type = 'response')) %>%
  bind_cols(setNames(as_tibble(predict(south_season_model, ., se.fit = TRUE)[1:2]),
                     c('fit_link','se_link'))) %>%
  mutate(fit_resp  = ilink_family_set(fit_link),
         right_upr = ilink_family_set(fit_link + (2 * se_link)),
         right_lwr = ilink_family_set(fit_link - (2 * se_link)))


fishery_name_south<- sort(unique(south_season_no_nas$finescale_fishery))

for (i in 1:length(fishery_name_south)){
  
  plot <- create_facet_plot(finescale_fishery_name = fishery_name_south[i], 
                            x_var = "creel_plus_summer", 
                            plot_data = south_season_no_nas, 
                            model_data = ndata) +
    ggtitle(paste(fishery_name_south[i]))
  
  print(plot)
}

```

## Northern BC AABM Spring and Fall fisheries

```{r forloop NBC AABM seasonal spring and fall appendix, results='asis', echo=FALSE}

north_aabm_season_model <- sport_catch_models$model_list$north_aabm_season
north_aabm_season_no_nas <- north_aabm_season_model$data

family_set <- family(north_aabm_season_model)
ilink_family_set<- family_set$linkinv

ndata <-
  north_aabm_season_no_nas %>% 
  group_by(status, finescale_fishery, season) %>%  
  tidyr::expand(historic_summer = seq(0, max(historic_summer), length=100)) %>%
  ## add the fitted values by predicting from the model for the new data
  add_column(fit = predict(north_aabm_season_model, 
                           newdata = ., 
                           type = 'response')) %>%
  bind_cols(setNames(as_tibble(predict(north_aabm_season_model, 
                                       ., 
                                       se.fit = TRUE)[1:2]),
                     c('fit_link','se_link'))) %>%
  
  mutate(fit_resp  = ilink_family_set(fit_link),
         right_upr = ilink_family_set(fit_link + (2 * se_link)),
         right_lwr = ilink_family_set(fit_link - (2 * se_link)))


fishery_name_north_aabm<- sort(unique(north_aabm_season_no_nas$finescale_fishery))


for (i in 1:length(fishery_name_north_aabm)){
  
  plot <- create_facet_plot(finescale_fishery_name = fishery_name_north_aabm[i], 
                            x_var = "historic_summer", 
                            plot_data = north_aabm_season_no_nas, 
                            model_data = ndata) +
    ggtitle(paste(fishery_name_north_aabm[i]))
  
  print(plot)
}
```

## Northern BC ISBM Spring and Fall fisheries

```{r forloop NBC ISBM seasonal spring and fall appendix, results='asis', echo=FALSE}


north_isbm_season_model <- sport_catch_models$model_list$north_isbm_season
north_isbm_season_no_nas <- north_isbm_season_model$data

family_set <- family(north_isbm_season_model)
ilink_family_set<- family_set$linkinv

ndata <-
  north_isbm_season_no_nas %>% 
  group_by(status, finescale_fishery, season) %>%  
  tidyr::expand(historic_summer = seq(0, max(historic_summer), length=100)) %>%
  ## add the fitted values by predicting from the model for the new data
  add_column(fit = predict(north_isbm_season_model, 
                           newdata = ., 
                           type = 'response')) %>%
  bind_cols(setNames(as_tibble(predict(north_isbm_season_model, 
                                       ., 
                                       se.fit = TRUE)[1:2]),
                     c('fit_link','se_link'))) %>%
  
  mutate(fit_resp  = ilink_family_set(fit_link),
         right_upr = ilink_family_set(fit_link + (2 * se_link)),
         right_lwr = ilink_family_set(fit_link - (2 * se_link)))


fishery_name_north_isbm<- sort(unique(north_isbm_season_no_nas$finescale_fishery))


for (i in 1:length(fishery_name_north_isbm)){
  
  plot <- create_facet_plot(finescale_fishery_name = fishery_name_north_isbm[i], 
                            x_var = "historic_summer", 
                            plot_data = north_isbm_season_no_nas, 
                            model_data = ndata) +
    ggtitle(paste(fishery_name_north_isbm[i]))
  
  print(plot)
}
```

`r if(knitr:::is_latex_output()) '% end csasdown appendix'`
